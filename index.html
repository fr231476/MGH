<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MGH [MiniGame Hepi] - Game Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; touch-action: manipulation; }
        .loader { border-top-color: #4f46e5; animation: spinner 0.6s linear infinite; }
        @keyframes spinner { to { transform: rotate(360deg); } }
        .modal-bg { background-color: rgba(0,0,0,0.5); }
        
        /* Game Frame Container */
        .game-frame-container { width: 100%; height: 100%; background: #eee; border-radius: 12px; overflow: hidden; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }

        /* Schulte Grid Styles */
        .grid-cell { transition: all 0.15s; user-select: none; display: flex; align-items: center; justify-content: center; font-weight: 900; }
        .correct { background-color: #10b981 !important; color: white !important; border-color: #059669 !important; }
        .wrong { animation: shake 0.3s; background-color: #ef4444 !important; color: white !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <!-- ==================== HOME VIEW ==================== -->
    <div id="home-view" class="max-w-md mx-auto min-h-screen bg-white shadow-xl flex flex-col">
        <div class="bg-indigo-600 p-6 text-white rounded-b-3xl">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-indigo-200 text-xs font-medium tracking-wide uppercase">MGH [MiniGame Hepi]</p>
                    <h2 id="display-name" class="text-xl font-bold text-white">Memuat...</h2>
                </div>
                <div id="auth-actions" class="hidden">
                    <button onclick="window.showAuthModal()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-full text-xs font-bold transition-all">
                        <i class="fas fa-user-circle mr-1"></i> Login
                    </button>
                </div>
                <div id="user-actions" class="hidden">
                    <button onclick="window.logout()" class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center transition-all hover:bg-indigo-400">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="p-6 space-y-6 flex-1 overflow-y-auto">
            <div class="flex bg-slate-100 p-1 rounded-xl">
                <button onclick="window.switchTab('games')" id="tab-games" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-indigo-600">Game</button>
                <button onclick="window.switchTab('creator')" id="tab-creator" class="flex-1 py-2 rounded-lg text-sm font-bold text-slate-500">Unggah</button>
                <button onclick="window.switchTab('rank')" id="tab-rank" class="flex-1 py-2 rounded-lg text-sm font-bold text-slate-500">Peringkat</button>
            </div>

            <!-- Tab Game -->
            <div id="content-games" class="space-y-4">
                <h3 class="text-slate-800 font-bold text-sm flex items-center gap-2">
                    <i class="fas fa-star text-amber-500"></i> Game Bawaan
                </h3>
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-5 rounded-2xl shadow-lg text-white">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl">
                            <i class="fas fa-th"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg">Tabel Schulte</h3>
                            <p class="text-xs text-indigo-100">Latih fokus & visi periferal</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="window.startSchulte(3)" class="bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition-all">3x3</button>
                        <button onclick="window.startSchulte(4)" class="bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition-all">4x4</button>
                        <button onclick="window.startSchulte(5)" class="bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition-all">5x5</button>
                        <button onclick="window.startSchulte(6)" class="bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition-all">6x6</button>
                        <button onclick="window.startSchulte(7)" class="bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition-all">7x7</button>
                        <button onclick="window.startSchulte(8)" class="bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition-all">8x8</button>
                        <button onclick="window.startSchulte(9)" class="bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition-all">9x9</button>
                        <button onclick="window.startSchulte(10)" class="bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition-all italic">10x10</button>
                    </div>
                </div>

                <h3 class="text-slate-800 font-bold text-sm pt-2 flex items-center gap-2">
                    <i class="fas fa-users text-indigo-500"></i> Game Komunitas
                </h3>
                <div id="community-games" class="grid grid-cols-1 gap-3">
                    <p class="text-[10px] text-slate-400 italic text-center py-10">Memuat game...</p>
                </div>
            </div>

            <!-- Tab Kreator -->
            <div id="content-creator" class="hidden space-y-4">
                <div class="bg-indigo-50 p-5 rounded-2xl border border-indigo-100">
                    <h3 class="font-bold text-indigo-900 mb-1">Unggah Game Buatanmu</h3>
                    <p class="text-xs text-indigo-700 mb-4">Masukkan file .html mandiri untuk membagikan kreasimu.</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">File Game (.html)</label>
                            <input type="file" id="creator-file" accept=".html" class="w-full bg-white border border-dashed border-slate-300 p-4 rounded-xl text-xs outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Nama Game</label>
                            <input type="text" id="creator-game-name" class="w-full bg-white border border-slate-200 p-3 rounded-xl text-sm outline-none" placeholder="Misal: Labirin Ajaib">
                        </div>
                        <button id="btn-publish" onclick="window.uploadCustomGame()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm shadow-md hover:bg-indigo-700 transition-all flex items-center justify-center gap-2 active:scale-95">
                            <i class="fas fa-upload"></i> Publikasikan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab Peringkat -->
            <div id="content-rank" class="hidden">
                <p class="text-center text-slate-400 py-10 text-xs italic">Fitur peringkat sedang dalam pemeliharaan.</p>
            </div>
        </div>
    </div>

    <!-- MODAL AUTH -->
    <div id="auth-modal" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl relative">
            <button onclick="window.hideAuthModal()" class="absolute top-4 right-4 text-slate-300 hover:text-slate-600"><i class="fas fa-times"></i></button>
            <h2 class="text-xl font-black text-slate-800 text-center mb-6">Masuk Ke MGH</h2>
            <div id="auth-form" class="space-y-4">
                <div id="auth-error" class="hidden p-3 bg-red-50 text-red-600 text-xs rounded-xl border border-red-100"></div>
                <input type="text" id="auth-username" class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm outline-none" placeholder="Username">
                <input type="password" id="auth-password" class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm outline-none" placeholder="Password (min 6)">
                <div class="flex gap-2">
                    <button id="btn-login" onclick="window.handleAuth('login')" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl text-sm disabled:opacity-50">Masuk</button>
                    <button id="btn-register" onclick="window.handleAuth('register')" class="flex-1 border-2 border-indigo-600 text-indigo-600 font-bold py-3 rounded-xl text-sm disabled:opacity-50">Daftar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GAME PLAYER VIEW -->
    <div id="game-view" class="fixed inset-0 bg-slate-900 hidden flex-col z-40">
        <div class="p-4 flex justify-between items-center text-white border-b border-white/10">
            <div class="flex items-center gap-3">
                <button onclick="window.exitGame()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20"><i class="fas fa-arrow-left"></i></button>
                <div id="game-status-ui" class="hidden flex items-center gap-4">
                    <h3 id="playing-title" class="font-bold text-sm">Schulte</h3>
                    <div class="flex items-center gap-2 bg-indigo-500/30 px-3 py-1 rounded-full border border-indigo-500/30">
                        <i class="far fa-clock text-[10px]"></i>
                        <span id="game-timer" class="font-mono text-sm font-bold">00.00</span>
                    </div>
                </div>
                <h3 id="generic-title" class="font-bold text-sm">MGH Player</h3>
            </div>
            <div id="game-extra-ui" class="flex items-center gap-3">
                <div id="next-label-container" class="hidden flex flex-col items-end">
                    <span class="text-[9px] text-indigo-300 uppercase font-black tracking-widest leading-none mb-1">Cari Angka</span>
                    <span id="next-label" class="text-lg font-black text-white leading-none">1</span>
                </div>
                <button onclick="location.reload()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10"><i class="fas fa-sync-alt text-xs opacity-60"></i></button>
            </div>
        </div>
        
        <div class="flex-1 p-4 flex items-center justify-center overflow-hidden">
            <div id="internal-game-area" class="w-full max-w-lg hidden h-full flex items-center justify-center">
                <div id="schulte-grid" class="grid gap-1.5 w-full max-h-full aspect-square p-2 bg-white/5 rounded-2xl border border-white/10"></div>
            </div>
            <div id="game-frame-wrapper" class="game-frame-container hidden"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, addDoc, collection, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global configuration
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mgh-game-v1';

        let currentUser = null;
        let schulteState = { active: false, expected: 1, startTime: 0, timerId: null };

        // --- AUTH UI UTILS ---
        const showAuthError = (msg) => {
            const errDiv = document.getElementById('auth-error');
            errDiv.innerText = msg;
            errDiv.classList.remove('hidden');
            setTimeout(() => errDiv.classList.add('hidden'), 5000);
        };

        // --- EXPORT TO WINDOW ---
        window.showAuthModal = () => {
            document.getElementById('auth-error').classList.add('hidden');
            document.getElementById('auth-modal').classList.remove('hidden');
        };
        window.hideAuthModal = () => document.getElementById('auth-modal').classList.add('hidden');
        
        window.logout = async () => {
            try { await signOut(auth); await signInAnonymously(auth); } catch (e) { console.error(e); }
        };

        window.handleAuth = async (type) => {
            const user = document.getElementById('auth-username').value.trim();
            const pass = document.getElementById('auth-password').value;
            const btnLogin = document.getElementById('btn-login');
            const btnReg = document.getElementById('btn-register');

            if (!user || pass.length < 6) return showAuthError("Username/Password tidak valid (min 6 karakter)");
            
            btnLogin.disabled = true;
            btnReg.disabled = true;

            try {
                const email = `${user.toLowerCase().replace(/\s/g, '')}@mgh.app`;
                
                if (type === 'register') {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    const querySnapshot = await getDocs(usersRef);
                    let exists = false;
                    querySnapshot.forEach((doc) => {
                        if (doc.data().username && doc.data().username.toLowerCase() === user.toLowerCase()) {
                            exists = true;
                        }
                    });

                    if (exists) {
                        showAuthError("Username tidak tersedia. Silakan gunakan nama lain.");
                        btnLogin.disabled = false;
                        btnReg.disabled = false;
                        return;
                    }

                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', cred.user.uid), { 
                        username: user, 
                        createdAt: Date.now() 
                    });
                } else { 
                    await signInWithEmailAndPassword(auth, email, pass); 
                }
                window.hideAuthModal();
            } catch (e) { 
                let msg = "Terjadi kesalahan sistem.";
                if (e.code === 'auth/wrong-password') msg = "Password salah.";
                if (e.code === 'auth/user-not-found') msg = "User tidak ditemukan.";
                showAuthError(msg);
            } finally {
                btnLogin.disabled = false;
                btnReg.disabled = false;
            }
        };

        window.switchTab = (tab) => {
            ['games', 'creator', 'rank'].forEach(t => {
                document.getElementById(`content-${t}`)?.classList.add('hidden');
                document.getElementById(`tab-${t}`)?.classList.replace('bg-white', 'text-slate-500');
            });
            document.getElementById(`content-${tab}`)?.classList.remove('hidden');
            const btn = document.getElementById(`tab-${tab}`);
            if(btn) {
                btn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                btn.classList.remove('text-slate-500');
            }
        };

        window.startSchulte = (size) => {
            document.getElementById('game-view').classList.remove('hidden');
            document.getElementById('internal-game-area').classList.remove('hidden');
            document.getElementById('game-frame-wrapper').classList.add('hidden');
            document.getElementById('game-status-ui').classList.remove('hidden');
            document.getElementById('next-label-container').classList.remove('hidden');
            document.getElementById('generic-title').classList.add('hidden');
            document.getElementById('playing-title').innerText = `Schulte ${size}x${size}`;
            
            const grid = document.getElementById('schulte-grid');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            
            schulteState = { active: false, expected: 1, startTime: 0, timerId: null };
            document.getElementById('game-timer').innerText = "00.00";
            document.getElementById('next-label').innerText = `1`;

            const total = size * size;
            const nums = Array.from({length: total}, (_, i) => i + 1).sort(() => Math.random() - 0.5);

            let fontSize = "text-xl";
            if (size > 4) fontSize = "text-lg";
            if (size > 6) fontSize = "text-sm";
            if (size > 8) fontSize = "text-[10px]";

            nums.forEach(n => {
                const btn = document.createElement('button');
                btn.className = `grid-cell bg-white border border-slate-200 rounded-lg shadow-sm active:scale-90 ${fontSize} text-slate-700`;
                btn.innerText = n;
                btn.onclick = () => {
                    if (!schulteState.active && n === 1) {
                        schulteState.active = true;
                        schulteState.startTime = Date.now();
                        schulteState.timerId = setInterval(() => {
                            const diff = (Date.now() - schulteState.startTime) / 1000;
                            document.getElementById('game-timer').innerText = diff.toFixed(2);
                        }, 50);
                    }

                    if (n === schulteState.expected) {
                        btn.classList.add('correct');
                        btn.onclick = null;
                        schulteState.expected++;
                        if (schulteState.expected > total) {
                            clearInterval(schulteState.timerId);
                            setTimeout(() => { 
                                alert(`Selesai! Waktu Anda untuk ${size}x${size}: ${document.getElementById('game-timer').innerText} detik`); 
                                window.exitGame(); 
                            }, 100);
                        } else {
                            document.getElementById('next-label').innerText = schulteState.expected;
                        }
                    } else {
                        btn.classList.add('wrong');
                        setTimeout(() => btn.classList.remove('wrong'), 300);
                    }
                };
                grid.appendChild(btn);
            });
        };

        window.playGame = (data) => {
            document.getElementById('game-view').classList.remove('hidden');
            document.getElementById('game-frame-wrapper').classList.remove('hidden');
            document.getElementById('internal-game-area').classList.add('hidden');
            document.getElementById('game-status-ui').classList.add('hidden');
            document.getElementById('next-label-container').classList.add('hidden');
            document.getElementById('generic-title').classList.remove('hidden');
            document.getElementById('generic-title').innerText = data.name;
            
            const wrapper = document.getElementById('game-frame-wrapper');
            wrapper.innerHTML = '';
            const iframe = document.createElement('iframe');
            iframe.sandbox = "allow-scripts allow-same-origin allow-forms allow-modals";
            iframe.srcdoc = data.content;
            wrapper.appendChild(iframe);
        };

        window.exitGame = () => {
            clearInterval(schulteState.timerId);
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('game-frame-wrapper').innerHTML = '';
            document.getElementById('schulte-grid').innerHTML = '';
        };

        window.uploadCustomGame = async () => {
            if (!currentUser || currentUser.isAnonymous) return window.showAuthModal();
            const fileInput = document.getElementById('creator-file');
            const nameInput = document.getElementById('creator-game-name');
            const name = nameInput.value.trim();
            if (!fileInput.files[0] || !name) return alert("Pilih file .html dan beri nama!");
            
            const btn = document.getElementById('btn-publish');
            btn.disabled = true; btn.innerText = "Proses...";

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'user_games'), {
                        name, creator: document.getElementById('display-name').innerText,
                        content: e.target.result, createdAt: Date.now()
                    });
                    alert("Game dipublikasikan!"); location.reload();
                } catch (err) { alert("Gagal mengunggah."); btn.disabled = false; }
            };
            reader.readAsText(fileInput.files[0]);
        };

        // --- INTERNAL INIT ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else { await signInAnonymously(auth); }
            } catch (e) { console.error(e); }
        };

        async function loadCommunityGames() {
            const container = document.getElementById('community-games');
            try {
                const snap = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'user_games'), limit(20)));
                container.innerHTML = snap.empty ? '<p class="text-center text-slate-400 py-10 text-xs">Belum ada game komunitas.</p>' : '';
                snap.forEach(d => {
                    const data = d.data();
                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm hover:border-indigo-300 transition-all cursor-pointer";
                    card.onclick = () => window.playGame(data);
                    card.innerHTML = `<div class="flex items-center gap-3"><div class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center"><i class="fas fa-gamepad"></i></div><div><h4 class="font-bold text-xs">${data.name}</h4><p class="text-[9px] text-slate-400 uppercase">${data.creator}</p></div></div><i class="fas fa-play text-indigo-600 text-xs opacity-40"></i>`;
                    container.appendChild(card);
                });
            } catch (e) { console.error(e); }
        }

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const displayNameElem = document.getElementById('display-name');
            const authActions = document.getElementById('auth-actions');
            const userActions = document.getElementById('user-actions');

            if (user && !user.isAnonymous) {
                authActions.classList.add('hidden');
                userActions.classList.remove('hidden');
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid));
                displayNameElem.innerText = snap.exists() ? snap.data().username : "User";
            } else {
                authActions.classList.remove('hidden');
                userActions.classList.add('hidden');
                displayNameElem.innerText = "Tamu (Offline)";
            }
            if (user) loadCommunityGames();
        });

        window.addEventListener('load', initAuth);
    </script>
</body>
</html>
